<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≤ Cardboard Hunter</title>
    <style>
        :root {
            --bg: #1a1a2e;
            --surface: #16213e;
            --surface-hover: #1f2b4d;
            --accent: #e94560;
            --accent-soft: #ff6b6b;
            --success: #4ecca3;
            --warning: #ffc857;
            --text: #edf2f4;
            --text-muted: #8d99ae;
            --border: #2d3a5a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .shutdown-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shutdown-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        h1 span {
            color: var(--accent);
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .panel {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Input area */
        .input-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        input[type="text"] {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text);
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        input[type="text"]::placeholder {
            color: var(--text-muted);
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.25rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        button:hover {
            background: var(--accent-soft);
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: var(--surface-hover);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            background: var(--border);
        }

        button.small {
            padding: 0.4rem 0.75rem;
            font-size: 0.85rem;
        }

        /* Wishlist */
        .wishlist {
            list-style: none;
        }

        .wishlist-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--bg);
            transition: background 0.2s, transform 0.2s, opacity 0.2s;
            cursor: grab;
        }

        .wishlist-item:hover {
            background: var(--surface-hover);
        }

        .wishlist-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .wishlist-item.drag-over {
            border-top: 2px solid var(--accent);
            margin-top: -2px;
        }

        .wishlist-item .drag-handle {
            color: var(--text-muted);
            cursor: grab;
            padding: 0 0.25rem;
            user-select: none;
        }

        .wishlist-item .priority {
            font-weight: 600;
            color: var(--accent);
            min-width: 2rem;
            text-align: center;
        }

        .wishlist-item .name {
            flex: 1;
        }

        .wishlist-item .actions {
            display: flex;
            gap: 0.5rem;
        }

        .wishlist-item button {
            background: transparent;
            padding: 0.3rem 0.5rem;
            font-size: 1rem;
        }

        .wishlist-item button:hover {
            background: var(--surface-hover);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        /* Check button */
        .check-section {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
        }

        .check-btn {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }

        /* Results */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: var(--bg);
            border-radius: 10px;
            padding: 1.25rem;
            text-align: center;
            border: 1px solid var(--border);
        }

        .summary-card .count {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--success);
        }

        .summary-card .label {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .summary-card.best {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(78, 204, 163, 0.2);
        }

        .summary-card.best .count {
            color: var(--success);
        }

        /* Results table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .results-table th {
            background: var(--bg);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .results-table tr:hover td {
            background: var(--surface-hover);
        }

        .results-table .game-name {
            font-weight: 500;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status.in-stock {
            background: rgba(78, 204, 163, 0.15);
            color: var(--success);
        }

        .status.out-of-stock {
            background: rgba(233, 69, 96, 0.15);
            color: var(--accent);
        }

        .status.not-found {
            background: rgba(141, 153, 174, 0.15);
            color: var(--text-muted);
        }

        .price {
            font-weight: 600;
            color: var(--warning);
        }

        .price.best-price {
            color: var(--success);
        }

        a {
            color: var(--accent-soft);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 2rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Import/Export */
        .io-section {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .results-table {
                display: block;
                overflow-x: auto;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }
        }

        /* Star toggle */
        .star-toggle {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
            padding: 0 0.25rem;
        }

        .star-toggle:hover {
            color: var(--warning);
            transform: none;
        }

        .star-toggle.starred {
            color: var(--warning);
        }

        /* View controls */
        .view-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        button.small.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .cart-limit-input {
            width: 3.5rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.3rem 0.5rem;
            color: var(--text);
            font-size: 0.85rem;
            text-align: center;
        }

        .cart-limit-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-left: 0.75rem;
        }

        /* Cart view */
        .cart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .cart-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .cart-card.has-starred {
            border-color: var(--warning);
            box-shadow: 0 0 15px rgba(255, 200, 87, 0.15);
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--surface-hover);
            border-bottom: 1px solid var(--border);
        }

        .cart-header .store-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .cart-header .score {
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .starred-badge {
            color: var(--warning);
            font-size: 0.85rem;
            padding: 0.5rem 1.25rem;
            background: rgba(255, 200, 87, 0.1);
        }

        .cart-items {
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 2rem 1.5rem 1fr auto auto;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid var(--border);
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item .item-priority {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .cart-item .item-star {
            color: var(--warning);
        }

        .cart-item .item-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cart-item .item-price {
            font-weight: 600;
            text-align: right;
        }

        .cart-item .price-badge {
            font-size: 0.75rem;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            min-width: 4rem;
            text-align: center;
        }

        .cart-item .price-badge.best {
            background: rgba(78, 204, 163, 0.2);
            color: var(--success);
        }

        .cart-item .price-badge.higher {
            background: rgba(233, 69, 96, 0.15);
            color: var(--accent-soft);
        }

        .cart-footer {
            padding: 1rem 1.25rem;
            background: var(--surface-hover);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-footer .total {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .cart-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .match-select {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            padding: 0.3rem 0.5rem;
            font-size: 0.8rem;
            max-width: 200px;
            cursor: pointer;
        }

        .match-select:hover {
            border-color: var(--accent);
        }

        /* Store carousel */
        .carousel-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--surface-hover);
            border-radius: 8px;
        }

        .carousel-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .carousel-btn:hover:not(:disabled) {
            background: var(--accent);
            border-color: var(--accent);
        }

        .carousel-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .carousel-dots {
            display: flex;
            gap: 0.5rem;
        }

        .carousel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .carousel-dot:hover {
            background: var(--text-muted);
        }

        .carousel-dot.active {
            background: var(--accent);
        }

        .carousel-info {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="shutdown-btn" onclick="shutdown()">Exit App</button>
            <h1>üé≤ Wishlist <span>Checker</span></h1>
            <p class="subtitle">Check board game availability across multiple retailers</p>
        </header>

        <div class="panel">
            <div class="panel-header">
                <h2 class="panel-title">üìã My Wishlist</h2>
                <div class="io-section">
                    <button class="secondary small" onclick="exportList()">Export</button>
                    <button class="secondary small" onclick="importList()">Import</button>
                    <button class="secondary small" onclick="clearList()">Clear All</button>
                </div>
            </div>

            <div class="input-row">
                <input type="text" id="gameInput" placeholder="Enter game name (e.g., Cascadia, Wingspan)" 
                       onkeypress="if(event.key === 'Enter') addGame()">
                <button onclick="addGame()">+ Add</button>
            </div>

            <ul class="wishlist" id="wishlist">
                <li class="empty-state">No games added yet. Add some games above!</li>
            </ul>
        </div>

        <div class="check-section">
            <button class="check-btn" onclick="checkAvailability()" id="checkBtn">
                üîç Check Availability
            </button>
        </div>

        <div class="panel" id="resultsPanel" style="display: none;">
            <div class="panel-header">
                <h2 class="panel-title">üìä Results</h2>
                <div class="view-controls">
                    <button class="secondary small active" id="tableViewBtn" onclick="setViewMode('table')">Table</button>
                    <button class="secondary small" id="cartViewBtn" onclick="setViewMode('cart')">Carts</button>
                    <span class="cart-limit-label">Top</span>
                    <input type="number" class="cart-limit-input" id="cartLimit" value="5" min="1" max="50" onchange="updateCartLimit()">
                    <button class="secondary small" onclick="refreshUI()" title="Refresh rankings">‚Üª</button>
                </div>
            </div>

            <div class="summary-cards" id="summary"></div>

            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        // State
        let wishlist = [];
        let viewMode = 'table';
        let cartLimit = 5;
        let lastResults = null;
        let selectedMatches = {}; // key: "gameIndex-storeIndex", value: match index (-1 = none)
        let carouselPage = 0;
        const STORES_PER_PAGE = 3;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadWishlist();
            renderWishlist();
        });

        // Wishlist management
        async function addGame() {
            const input = document.getElementById('gameInput');
            const name = input.value.trim();

            if (!name) return;

            if (wishlist.some(g => g.name.toLowerCase() === name.toLowerCase())) {
                alert('Game already in wishlist');
                return;
            }

            wishlist.push({ name, priority: wishlist.length + 1 });
            await saveWishlist();
            renderWishlist();
            input.value = '';
            input.focus();
        }

        async function removeGame(index) {
            wishlist.splice(index, 1);
            // Reorder priorities
            wishlist.forEach((g, i) => g.priority = i + 1);
            await saveWishlist();
            renderWishlist();
        }

        async function toggleStar(index) {
            wishlist[index].starred = !wishlist[index].starred;
            await saveWishlist();
            renderWishlist();
        }

        // Drag and drop
        let draggedIndex = null;

        function handleDragStart(e, index) {
            draggedIndex = index;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.wishlist-item').forEach(el => el.classList.remove('drag-over'));
            draggedIndex = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e, index) {
            if (index !== draggedIndex) {
                e.currentTarget.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        async function handleDrop(e, targetIndex) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (draggedIndex === null || draggedIndex === targetIndex) return;

            const [moved] = wishlist.splice(draggedIndex, 1);
            wishlist.splice(targetIndex, 0, moved);
            wishlist.forEach((g, i) => g.priority = i + 1);
            await saveWishlist();
            renderWishlist();
        }

        // Load wishlist from server
        async function loadWishlist() {
            try {
                const response = await fetch('/api/games');
                if (response.ok) {
                    wishlist = await response.json();
                }
            } catch (err) {
                console.error('Failed to load wishlist:', err);
            }
        }

        // Save wishlist to server
        async function saveWishlist() {
            try {
                const response = await fetch('/api/games', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(wishlist)
                });
                if (!response.ok) {
                    throw new Error('Failed to save');
                }
            } catch (err) {
                console.error('Failed to save wishlist:', err);
                alert('Failed to save wishlist. Please try again.');
            }
        }

        function renderWishlist() {
            const container = document.getElementById('wishlist');

            if (wishlist.length === 0) {
                container.innerHTML = '<li class="empty-state">No games added yet. Add some games above!</li>';
                return;
            }

            container.innerHTML = wishlist.map((game, i) => `
                <li class="wishlist-item" draggable="true"
                    ondragstart="handleDragStart(event, ${i})"
                    ondragend="handleDragEnd(event)"
                    ondragover="handleDragOver(event)"
                    ondragenter="handleDragEnter(event, ${i})"
                    ondragleave="handleDragLeave(event)"
                    ondrop="handleDrop(event, ${i})">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="priority">#${game.priority}</span>
                    <button class="star-toggle ${game.starred ? 'starred' : ''}"
                            onclick="toggleStar(${i})" title="Toggle must-have">
                        ${game.starred ? '‚òÖ' : '‚òÜ'}
                    </button>
                    <span class="name">${escapeHtml(game.name)}</span>
                    <div class="actions">
                        <button onclick="removeGame(${i})" title="Remove">√ó</button>
                    </div>
                </li>
            `).join('');
        }

        // Import/Export
        function exportList() {
            const data = wishlist.map(g => g.name).join('\n');
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'wishlist.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function importList() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.csv';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const text = await file.text();
                const lines = text.split(/[\n,]/).map(l => l.trim()).filter(l => l);

                lines.forEach(name => {
                    if (!wishlist.some(g => g.name.toLowerCase() === name.toLowerCase())) {
                        wishlist.push({ name, priority: wishlist.length + 1 });
                    }
                });

                await saveWishlist();
                renderWishlist();
            };
            input.click();
        }

        async function clearList() {
            if (!confirm('Clear entire wishlist?')) return;
            wishlist = [];
            await saveWishlist();
            renderWishlist();
            document.getElementById('resultsPanel').style.display = 'none';
        }

        // Check availability
        async function checkAvailability() {
            if (wishlist.length === 0) {
                alert('Add some games to your wishlist first!');
                return;
            }

            const btn = document.getElementById('checkBtn');
            const resultsPanel = document.getElementById('resultsPanel');
            const resultsContent = document.getElementById('resultsContent');
            const summary = document.getElementById('summary');

            btn.disabled = true;
            btn.textContent = '‚è≥ Checking...';
            resultsPanel.style.display = 'block';
            resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div>Checking stores...</div>';
            summary.innerHTML = '';

            try {
                const response = await fetch('/api/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ games: wishlist })
                });

                if (!response.ok) throw new Error('Check failed');

                const data = await response.json();
                selectedMatches = {}; // Reset selections on new search
                carouselPage = 0; // Reset carousel to first page
                renderResults(data);
            } catch (err) {
                resultsContent.innerHTML = `<div class="empty-state">Error: ${err.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Check Availability';
            }
        }

        function renderResults(data) {
            lastResults = data;
            const summary = document.getElementById('summary');

            // Find best store
            const stores = Object.entries(data.summary);
            const maxCount = Math.max(...stores.map(([, c]) => c));

            // Render summary cards
            summary.innerHTML = stores.map(([store, count]) => `
                <div class="summary-card ${count === maxCount && count > 0 ? 'best' : ''}">
                    <div class="count">${count}</div>
                    <div class="label">${store}</div>
                </div>
            `).join('');

            // Dispatch to correct view
            if (viewMode === 'cart') {
                renderCartView(data);
            } else {
                renderTableView(data);
            }
        }

        function getEffectiveResult(result, gameIndex, storeIndex) {
            const key = `${gameIndex}-${storeIndex}`;
            const matches = result.matches || [];
            const selectedIdx = selectedMatches[key];

            if (selectedIdx === -1) {
                // Excluded
                return { ...result, found: false, excluded: true };
            }
            if (selectedIdx !== undefined && matches[selectedIdx]) {
                const m = matches[selectedIdx];
                return { ...result, title: m.title, url: m.url, price: m.price, priceNum: m.priceNum, inStock: m.inStock };
            }
            return result;
        }

        // Carousel helpers
        function getTotalPages(totalItems) {
            return Math.ceil(totalItems / STORES_PER_PAGE);
        }

        function getVisibleRange(totalItems) {
            const start = carouselPage * STORES_PER_PAGE;
            const end = Math.min(start + STORES_PER_PAGE, totalItems);
            return { start, end };
        }

        function renderCarouselControls(totalItems) {
            const totalPages = getTotalPages(totalItems);
            if (totalPages <= 1) return '';

            const { start, end } = getVisibleRange(totalItems);
            const dots = Array.from({ length: totalPages }, (_, i) =>
                `<button class="carousel-dot ${i === carouselPage ? 'active' : ''}" onclick="carouselGoTo(${i})"></button>`
            ).join('');

            return `
                <div class="carousel-controls">
                    <button class="carousel-btn" onclick="carouselPrev()" ${carouselPage === 0 ? 'disabled' : ''}>‚Üê</button>
                    <div class="carousel-dots">${dots}</div>
                    <button class="carousel-btn" onclick="carouselNext()" ${carouselPage >= totalPages - 1 ? 'disabled' : ''}>‚Üí</button>
                    <span class="carousel-info">Stores ${start + 1}-${end} of ${totalItems}</span>
                </div>
            `;
        }

        function carouselPrev() {
            if (carouselPage > 0) {
                carouselPage--;
                renderResults(lastResults);
            }
        }

        function carouselNext() {
            const totalPages = getTotalPages(Object.keys(lastResults.summary).length);
            if (carouselPage < totalPages - 1) {
                carouselPage++;
                renderResults(lastResults);
            }
        }

        function carouselGoTo(page) {
            carouselPage = page;
            renderResults(lastResults);
        }

        function renderTableView(data) {
            const resultsContent = document.getElementById('resultsContent');
            const allStores = Object.entries(data.summary);
            const { start, end } = getVisibleRange(allStores.length);
            const visibleStores = allStores.slice(start, end);
            const visibleStoreNames = visibleStores.map(([name]) => name);

            // Build store index mapping (original index for each visible store)
            const storeIndexMap = new Map();
            allStores.forEach(([name], idx) => storeIndexMap.set(name, idx));

            let tableHtml = renderCarouselControls(allStores.length);

            tableHtml += `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Game</th>
                            ${visibleStoreNames.map(s => `<th>${s}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.results.forEach((game, gameIndex) => {
                // Get effective results with user selections applied (for ALL stores, for best price calc)
                const effectiveResults = game.results.map((r, storeIndex) =>
                    getEffectiveResult(r, gameIndex, storeIndex)
                );

                // Find best price for this game across ALL stores (in-stock only)
                const prices = effectiveResults
                    .filter(r => r.found && r.inStock && r.priceNum > 0)
                    .map(r => r.priceNum);
                const bestPrice = prices.length > 0 ? Math.min(...prices) : null;

                // Only render cells for visible stores
                const visibleCells = visibleStoreNames.map(storeName => {
                    const storeIndex = storeIndexMap.get(storeName);
                    return renderStoreCell(game.results[storeIndex], bestPrice, gameIndex, storeIndex);
                }).join('');

                tableHtml += `<tr>
                    <td>${gameIndex + 1}</td>
                    <td class="game-name">${escapeHtml(game.name)}</td>
                    ${visibleCells}
                </tr>`;
            });

            tableHtml += '</tbody></table>';
            resultsContent.innerHTML = tableHtml;
        }

        function renderStoreCell(result, bestPrice, gameIndex, storeIndex) {
            if (result.error) {
                return `<td><span class="status not-found">‚ö†Ô∏è Error</span></td>`;
            }

            if (!result.found) {
                return `<td><span class="status not-found">‚Äî</span></td>`;
            }

            const key = `${gameIndex}-${storeIndex}`;
            const matches = result.matches || [];
            const selectedIdx = selectedMatches[key] ?? 0;
            const effective = getEffectiveResult(result, gameIndex, storeIndex);

            // Check if excluded
            if (selectedIdx === -1) {
                return `<td>
                    <span class="status not-found">‚úó Excluded</span><br>
                    <select class="match-select" onchange="selectMatch(${gameIndex}, ${storeIndex}, this.value)">
                        <option value="-1" selected>‚Äî None ‚Äî</option>
                        ${matches.map((m, i) => {
                            const label = truncate(m.title, 30) + ' - ' + m.price + (m.inStock ? '' : ' (OOS)');
                            return `<option value="${i}">${escapeHtml(label)}</option>`;
                        }).join('')}
                    </select>
                </td>`;
            }

            const isBestPrice = bestPrice && effective.priceNum === bestPrice && effective.inStock;

            let html = '<td>';

            if (effective.inStock) {
                html += `<span class="status in-stock">‚úì In Stock</span><br>`;
                html += `<span class="price ${isBestPrice ? 'best-price' : ''}">${effective.price}</span>`;
                html += isBestPrice ? ' ‚≠ê' : '';
                html += '<br>';
            } else {
                html += `<span class="status out-of-stock">‚úó Out of Stock</span><br>`;
            }

            if (matches.length > 1) {
                html += `<select class="match-select" onchange="selectMatch(${gameIndex}, ${storeIndex}, this.value)">`;
                html += `<option value="-1">‚Äî None ‚Äî</option>`;
                matches.forEach((m, i) => {
                    const label = truncate(m.title, 30) + ' - ' + m.price + (m.inStock ? '' : ' (OOS)');
                    html += `<option value="${i}"${i === selectedIdx ? ' selected' : ''}>${escapeHtml(label)}</option>`;
                });
                html += `</select>`;
            } else {
                html += `<a href="${effective.url}" target="_blank">View ‚Üí</a>`;
            }

            html += '</td>';
            return html;
        }

        function selectMatch(gameIndex, storeIndex, value) {
            const key = `${gameIndex}-${storeIndex}`;
            selectedMatches[key] = parseInt(value);
            renderResults(lastResults);
        }

        function truncate(str, len) {
            return str.length > len ? str.slice(0, len) + '...' : str;
        }

        function calculateCartRankings(results) {
            const totalItems = wishlist.length;
            const storeMap = new Map();

            // Build best prices map using effective results (with user selections)
            // Only consider items that are found, in stock, and have valid prices
            const bestPrices = new Map();
            results.forEach((game, gameIndex) => {
                const prices = game.results
                    .map((r, storeIndex) => getEffectiveResult(r, gameIndex, storeIndex))
                    .filter(r => r.found && r.inStock && r.priceNum > 0)
                    .map(r => r.priceNum);
                if (prices.length > 0) {
                    bestPrices.set(game.name, Math.min(...prices));
                }
            });

            // Process each game result using effective results
            results.forEach((game, gameIndex) => {
                const priority = gameIndex + 1;
                const isStarred = wishlist[gameIndex]?.starred || false;
                const basePoints = totalItems - priority + 1;

                game.results.forEach((storeResult, storeIndex) => {
                    const effective = getEffectiveResult(storeResult, gameIndex, storeIndex);
                    // Skip if not found, not in stock, or excluded by user
                    if (!effective.found || !effective.inStock || effective.excluded) return;

                    if (!storeMap.has(storeResult.store)) {
                        storeMap.set(storeResult.store, {
                            name: storeResult.store,
                            score: 0,
                            items: [],
                            hasStarred: false
                        });
                    }

                    const store = storeMap.get(storeResult.store);
                    if (isStarred) store.hasStarred = true;

                    const bestPrice = bestPrices.get(game.name);
                    const hasValidPrice = effective.priceNum > 0;
                    const isBestPrice = hasValidPrice && bestPrice && effective.priceNum === bestPrice;
                    const priceDiff = (hasValidPrice && bestPrice) ? effective.priceNum - bestPrice : 0;

                    // Double points for best price items
                    const points = isBestPrice ? basePoints * 2 : basePoints;
                    store.score += points;

                    store.items.push({
                        priority,
                        name: game.name,
                        starred: isStarred,
                        price: hasValidPrice ? effective.price : 'N/A',
                        priceNum: effective.priceNum || 0,
                        url: effective.url,
                        isBestPrice,
                        priceDiff,
                        hasValidPrice
                    });
                });
            });

            // Apply starred bonus and sort
            const rankings = Array.from(storeMap.values());
            rankings.forEach(store => {
                if (store.hasStarred) store.score += 1000;
                store.items.sort((a, b) => a.priority - b.priority);
            });

            rankings.sort((a, b) => b.score - a.score);
            return rankings;
        }

        function renderCartView(data) {
            const resultsContent = document.getElementById('resultsContent');
            const rankings = calculateCartRankings(data.results);

            if (rankings.length === 0) {
                resultsContent.innerHTML = '<div class="cart-empty">No stores have items in stock</div>';
                return;
            }

            // Apply carousel to cart view
            const { start, end } = getVisibleRange(rankings.length);
            const visibleRankings = rankings.slice(start, end);

            resultsContent.innerHTML = `
                ${renderCarouselControls(rankings.length)}
                <div class="cart-grid">
                    ${visibleRankings.map(store => {
                        const displayItems = store.items.slice(0, cartLimit);
                        const total = displayItems.reduce((sum, item) => sum + item.priceNum, 0);

                        return `
                            <div class="cart-card ${store.hasStarred ? 'has-starred' : ''}">
                                <div class="cart-header">
                                    <span class="store-name">${escapeHtml(store.name)}</span>
                                    <span class="score">${store.score} pts</span>
                                </div>
                                ${store.hasStarred ? '<div class="starred-badge">‚òÖ Has must-have items</div>' : ''}
                                <ul class="cart-items">
                                    ${displayItems.map(item => `
                                        <li class="cart-item">
                                            <span class="item-priority">#${item.priority}</span>
                                            <span class="item-star">${item.starred ? '‚òÖ' : ''}</span>
                                            <a href="${item.url}" target="_blank" class="item-name" title="${escapeHtml(item.name)}">
                                                ${escapeHtml(item.name)}
                                            </a>
                                            <span class="item-price">${item.price}</span>
                                            ${item.hasValidPrice ? `
                                                <span class="price-badge ${item.isBestPrice ? 'best' : 'higher'}">
                                                    ${item.isBestPrice ? 'BEST' : '+$' + item.priceDiff.toFixed(2)}
                                                </span>
                                            ` : '<span class="price-badge">‚Äî</span>'}
                                        </li>
                                    `).join('')}
                                </ul>
                                <div class="cart-footer">
                                    <span>${displayItems.length} item${displayItems.length !== 1 ? 's' : ''}</span>
                                    <span class="total">${total > 0 ? '$' + total.toFixed(2) : 'N/A'}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('tableViewBtn').classList.toggle('active', mode === 'table');
            document.getElementById('cartViewBtn').classList.toggle('active', mode === 'cart');
            if (lastResults) {
                renderResults(lastResults);
            }
        }

        function updateCartLimit() {
            cartLimit = parseInt(document.getElementById('cartLimit').value) || 5;
            if (lastResults && viewMode === 'cart') {
                renderResults(lastResults);
            }
        }

        function refreshUI() {
            if (lastResults) {
                carouselPage = 0; // Reset to first page
                renderResults(lastResults);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function shutdown() {
            if (!confirm('Exit the application?')) return;
            try {
                await fetch('/api/shutdown', { method: 'POST' });
            } catch (e) {
                // Expected - server shuts down
            }
            document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:var(--text-muted);">Application closed. You can close this tab.</div>';
        }
    </script>
</body>
</html>
